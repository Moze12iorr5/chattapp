<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OmeStarChat</title>
<style>
  body { font-family: Arial, sans-serif; }
  #messages { list-style: none; max-height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 5px; }
  #messages li { margin-bottom: 10px; }
  img.chat-image { max-width: 150px; display: block; margin-top: 5px; }
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<h1>Welcome to OmeStarChat</h1>

<p><a href="rules.html">Rules</a> | <a href="faq.html">FAQ</a> | <a href="about.html">About</a> | <a href="contact.html">Contact</a></p>

<ul id="messages"></ul>

<input id="input" autocomplete="off" placeholder="Type your message..." />
<button id="sendBtn">Send</button>

<h3>Upload Image</h3>
<input type="file" id="imageUpload" accept="image/*" />
<button id="uploadBtn">Upload</button>

<script>
  const socket = io();

  let username = '';
  while (!username) {
    username = prompt('Enter your username:').trim();
  }

  const input = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const messages = document.getElementById('messages');
  const imageUpload = document.getElementById('imageUpload');
  const uploadBtn = document.getElementById('uploadBtn');

  sendBtn.onclick = () => {
    const text = input.value.trim();
    if (text !== '') {
      socket.emit('chat message', { user: username, text });
      input.value = '';
    }
  };

  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendBtn.click();
  });

  socket.on('chat message', (msg) => {
    if (msg.image) {
      const li = document.createElement('li');
      li.textContent = `${msg.user} sent an image:`;
      const img = document.createElement('img');
      img.src = msg.image;
      img.className = 'chat-image';
      li.appendChild(img);
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    } else {
      const li = document.createElement('li');
      li.textContent = `${msg.user}: ${msg.text}`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }
  });

  uploadBtn.onclick = () => {
    if (imageUpload.files.length === 0) return alert('Please select an image first!');
    const file = imageUpload.files[0];
    const formData = new FormData();
    formData.append('image', file);

    fetch('/upload', {
      method: 'POST',
      body: formData
    }).then(res => {
      if (!res.ok) throw new Error('Upload failed');
      return res.json();
    }).then(data => {
      socket.emit('chat message', {
        user: username,
        text: '',
        image: `/uploads/${data.filename}`
      });
    }).catch(err => alert(err.message));
  };
</script>
</body>
</html>
